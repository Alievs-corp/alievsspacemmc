<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Leads â€” Admin</title>
  <link rel="stylesheet" href="./css/admin.css"/>
</head>
<body>
  <div class="shell">
    <aside class="sidebar" id="sidebar"></aside>
    <main class="content">
      
<div class="card">
  <div class="split">
    <div>
      <div class="h1">Leads</div>
      <div class="small">Requests submitted from the Contact page.</div>
    </div>
    <div class="row" style="display:flex; gap:10px">
      <button class="btn" id="exportBtn">Export JSON</button>
      <button class="btn" id="clearBtn">Clear leads</button>
    </div>
  </div>
  <div class="hr"></div>

  <div id="tableMount"></div>

  <div class="hr"></div>
  <div class="card" style="box-shadow:none">
    <div class="h2">Update status</div>
    <div class="two">
      <div class="grid">
        <label class="small">Lead ID</label>
        <input class="input" id="leadId" placeholder="Select from table..." />
      </div>
      <div class="grid">
        <label class="small">Status</label>
        <select class="input" id="status">
          <option>New</option>
          <option>In Progress</option>
          <option>Contacted</option>
          <option>Closed</option>
        </select>
      </div>
    </div>
    <div class="hr"></div>
    <button class="btn primary" id="updateBtn">Update</button>
  </div>
</div>
<script type="module">
  import { requireAuth, logout } from "./js/auth.js";
  import { bootstrapIfNeeded, load, save, download } from "./js/store.js";
  import { mountShell, toast } from "./js/modules/layout.js";

  requireAuth();
  await bootstrapIfNeeded();
  mountShell("leads");
  document.getElementById("logoutBtn")?.addEventListener("click", ()=>{ logout(); location.href="./login.html"; });

  function render(){
    const c = load();
    const rows = c.leads || [];
    const mount = document.getElementById("tableMount");
    if (!rows.length){
      mount.innerHTML = '<div class="small">No leads yet. Submit one from the public Contact page.</div>';
      return;
    }
    mount.innerHTML = `
      <table class="table">
        <thead><tr><th>Date</th><th>Name</th><th>Contact</th><th>Interest</th><th>Status</th><th>ID</th></tr></thead>
        <tbody>
          ${rows.map(r=>`
            <tr data-id="${r.id}">
              <td>${(r.createdAt||"").slice(0,10)}</td>
              <td>${esc(r.name||"")}</td>
              <td>${esc((r.email||"") + (r.phone?(" / "+r.phone):""))}</td>
              <td>${esc(r.interest||"")}</td>
              <td><span class="badge"><i></i> ${esc(r.status||"New")}</span></td>
              <td style="font-family:var(--mono)">${esc(r.id||"")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    mount.querySelectorAll("tr[data-id]").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        document.getElementById("leadId").value = tr.dataset.id;
      });
    });
  }

  document.getElementById("updateBtn").addEventListener("click", ()=>{
    const id = document.getElementById("leadId").value.trim();
    const st = document.getElementById("status").value;
    if (!id) return toast("Select a lead first");
    const c = load();
    const lead = (c.leads||[]).find(x=>x.id===id);
    if (!lead) return toast("Lead not found");
    lead.status = st;
    save(c);
    toast("Updated");
    render();
  });

  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const c = load();
    download("leads.json", c.leads||[]);
  });

  document.getElementById("clearBtn").addEventListener("click", ()=>{
    const c = load();
    c.leads = [];
    save(c);
    toast("Cleared");
    render();
  });

  function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
  render();
</script>

    </main>
  </div>
  <script type="module">
    import { requireAuth, logout } from "./js/auth.js";
    import { mountShell, toast } from "./js/modules/layout.js";
    requireAuth();
    mountShell("leads");
    const lb = document.getElementById("logoutBtn");
    lb?.addEventListener("click", ()=>{ logout(); location.href="./login.html"; });
  </script>
  
</body>
</html>
