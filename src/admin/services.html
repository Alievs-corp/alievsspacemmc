<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Services â€” Admin</title>
  <link rel="stylesheet" href="./css/admin.css"/>
</head>
<body>
  <div class="shell">
    <aside class="sidebar" id="sidebar"></aside>
    <main class="content">
      
<div class="card">
  <div class="split">
    <div>
      <div class="h1">Services</div>
      <div class="small">Add, edit, and delete services shown on the public website.</div>
    </div>
    <div class="row" style="display:flex; gap:10px">
      <button class="btn" id="newBtn">New service</button>
    </div>
  </div>
  <div class="hr"></div>

  <div id="tableMount"></div>

  <div class="hr"></div>
  <div class="card" style="box-shadow:none">
    <div class="h2" id="formTitle">Create / Edit</div>
    <form id="svcForm" class="grid">
      <div id="svcForm_fields" class="two"></div>
      <div class="row" style="display:flex; gap:10px">
        <button class="btn primary" type="submit">Save</button>
        <button class="btn" type="button" id="svcForm_cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>
<script type="module">
  import { requireAuth, logout } from "./js/auth.js";
  import { bootstrapIfNeeded, load, save, listLocales, getLocale } from "./js/store.js";
  import { mountShell, toast } from "./js/modules/layout.js";
  import { renderTable, bindForm } from "./js/modules/crud.js";

  requireAuth();
  await bootstrapIfNeeded();
  mountShell("services");
  document.getElementById("logoutBtn")?.addEventListener("click", ()=>{ logout(); location.href="./login.html"; });

  let editingId = null;
  const currentLocale = getLocale();

  function propagateNew(item){
    const others = (listLocales() || []).filter(l=>l!==currentLocale);
    others.forEach(loc=>{
      const data = load(loc);
      const arr = data.services || [];
      if (arr.some(x=>x.id===item.id)) return;
      data.services = [item, ...arr];
      save(data, loc);
    });
  }

  function refresh(){
    const c = load();
    const rows = c.services || [];
    renderTable({
      mountId:"tableMount",
      columns:[
        {key:"category", label:"Category"},
        {key:"title", label:"Title"},
        {key:"desc", label:"Description"}
      ],
      rows,
      onEdit:(id)=>{ editingId=id; renderForm(); },
      onDelete:(id)=>{
        const next = load();
        next.services = (next.services||[]).filter(x=>x.id!==id);
        save(next); toast("Deleted"); refresh();
      }
    });
    renderForm();
  }

  function renderForm(){
    const c = load();
    const current = editingId ? (c.services||[]).find(x=>x.id===editingId) : null;
    document.getElementById("formTitle").textContent = editingId ? "Edit service" : "Create service";
    bindForm({
      formId:"svcForm",
      fields:[
        {key:"category", label:"Category", placeholder:"Software / Commerce / Banking"},
        {key:"title", label:"Title", placeholder:"Web & Mobile Development"},
        {key:"desc", label:"Description", placeholder:"Short premium description"},
        {key:"bullets", label:"Bullets (comma-separated)", placeholder:"Premium UI, Performance, ..."}
      ],
      getCurrent:()=> current ? ({...current, bullets:(current.bullets||[]).join(", ")}) : null,
      onSubmit:(item)=>{
        const next = load();
        item.bullets = item.bullets ? item.bullets.split(",").map(s=>s.trim()).filter(Boolean) : [];
        const arr = next.services || [];
        const idx = arr.findIndex(x=>x.id===item.id);
        if (idx>=0) arr[idx]=item; else arr.unshift(item);
        next.services = arr;
        save(next);
        propagateNew(item);
        toast("Saved");
        editingId = null;
        refresh();
      },
      onCancel:()=>{ editingId=null; refresh(); }
    });
  }

  document.getElementById("newBtn").addEventListener("click", ()=>{ editingId=null; renderForm(); toast("New service"); });
  refresh();
</script>

    </main>
  </div>
  <script type="module">
    import { requireAuth, logout } from "./js/auth.js";
    import { mountShell, toast } from "./js/modules/layout.js";
    requireAuth();
    mountShell("services");
    const lb = document.getElementById("logoutBtn");
    lb?.addEventListener("click", ()=>{ logout(); location.href="./login.html"; });
  </script>
  
</body>
</html>
