<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Projects â€” Admin</title>
  <link rel="stylesheet" href="./css/admin.css"/>
</head>
<body>
  <div class="shell">
    <aside class="sidebar" id="sidebar"></aside>
    <main class="content">
      
<div class="card">
  <div class="split">
    <div>
      <div class="h1">Projects</div>
      <div class="small">Manage case studies shown on the public website.</div>
    </div>
    <button class="btn" id="newBtn">New project</button>
  </div>
  <div class="hr"></div>

  <div id="tableMount"></div>

  <div class="hr"></div>
  <div class="card" style="box-shadow:none">
    <div class="h2" id="formTitle">Create / Edit</div>
    <form id="prjForm" class="grid">
      <div id="prjForm_fields" class="two"></div>
      <div class="row" style="display:flex; gap:10px">
        <button class="btn primary" type="submit">Save</button>
        <button class="btn" type="button" id="prjForm_cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>
<script type="module">
  import { requireAuth, logout } from "./js/auth.js";
  import { bootstrapIfNeeded, load, save, listLocales, getLocale } from "./js/store.js";
  import { mountShell, toast } from "./js/modules/layout.js";
  import { renderTable, bindForm } from "./js/modules/crud.js";

  requireAuth();
  await bootstrapIfNeeded();
  mountShell("projects");
  document.getElementById("logoutBtn")?.addEventListener("click", ()=>{ logout(); location.href="./login.html"; });

  let editingId = null;
  const currentLocale = getLocale();

  function propagateNew(item){
    const others = (listLocales()||[]).filter(l=>l!==currentLocale);
    others.forEach(loc=>{
      const data = load(loc);
      const arr = data.projects || [];
      if (arr.some(x=>x.id===item.id)) return;
      data.projects = [item, ...arr];
      save(data, loc);
    });
  }

  function refresh(){
    const c = load();
    const rows = c.projects || [];
    renderTable({
      mountId:"tableMount",
      columns:[
        {key:"industry", label:"Industry"},
        {key:"title", label:"Title"},
        {key:"summary", label:"Summary"}
      ],
      rows,
      onEdit:(id)=>{ editingId=id; renderForm(); },
      onDelete:(id)=>{
        const next = load();
        next.projects = (next.projects||[]).filter(x=>x.id!==id);
        save(next); toast("Deleted"); refresh();
      }
    });
    renderForm();
  }

  function renderForm(){
    const c = load();
    const current = editingId ? (c.projects||[]).find(x=>x.id===editingId) : null;
    document.getElementById("formTitle").textContent = editingId ? "Edit project" : "Create project";
    bindForm({
      formId:"prjForm",
      fields:[
        {key:"id", label:"ID (unique)", placeholder:"prj_mycase", default:""},
        {key:"industry", label:"Industry", placeholder:"E-commerce / Banking"},
        {key:"title", label:"Title", placeholder:"Project title"},
        {key:"summary", label:"Summary", placeholder:"One-paragraph summary"},
        {key:"tags", label:"Tags (comma-separated)", placeholder:"Marketplace, Admin, Security"},
        {key:"link", label:"External link", placeholder:"https://..."}
      ],
      getCurrent:()=> current ? ({...current, tags:(current.tags||[]).join(", ")}) : null,
      onSubmit:(item)=>{
        const next = load();
        item.id = item.id || (current?.id) || ("prj_"+Math.random().toString(16).slice(2));
        item.tags = item.tags ? item.tags.split(",").map(s=>s.trim()).filter(Boolean) : [];
        const arr = next.projects || [];
        const idx = arr.findIndex(x=>x.id===item.id);
        if (idx>=0) arr[idx]=item; else arr.unshift(item);
        next.projects = arr;
        save(next);
        propagateNew(item);
        toast("Saved");
        editingId = null;
        refresh();
      },
      onCancel:()=>{ editingId=null; refresh(); }
    });
  }

  document.getElementById("newBtn").addEventListener("click", ()=>{ editingId=null; renderForm(); toast("New project"); });
  refresh();
</script>

    </main>
  </div>
  <script type="module">
    import { requireAuth, logout } from "./js/auth.js";
    import { mountShell, toast } from "./js/modules/layout.js";
    requireAuth();
    mountShell("projects");
    const lb = document.getElementById("logoutBtn");
    lb?.addEventListener("click", ()=>{ logout(); location.href="./login.html"; });
  </script>
  
</body>
</html>
